<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoPay Notifikace</title>
    <!-- Firebase SDK -->
    <script type="module" src="firebase-init.js"></script>
    <!-- GoPay API Wrapper -->
    <script src="gopay.js"></script>
</head>
<body>
    <h1>Zpracov√°v√°n√≠ GoPay notifikace...</h1>
    <script>
        // GoPay konfigurace (stejn√° jako v packages.js)
        const GOPAY_CONFIG = {
            isTest: true, // Pro produkci zmƒõ≈à na false
            clientId: '1204015758',
            clientSecret: '7WFS2HCS',
            goId: '8419533331'
        };

        // Zpracov√°n√≠ notifikace
        async function processNotification() {
            try {
                // Z√≠sk√°n√≠ ID platby z URL parametru
                const urlParams = new URLSearchParams(window.location.search);
                const paymentId = urlParams.get('id');

                if (!paymentId) {
                    console.error('‚ùå Chyb√≠ ID platby v notifikaci');
                    document.body.innerHTML = '<h1>Chyba: Chyb√≠ ID platby</h1>';
                    return;
                }

                console.log('üì¨ Zpracov√°v√°m GoPay notifikaci pro platbu:', paymentId);

                // Poƒçkat na Firebase
                let retries = 0;
                while (!window.firebaseDb && retries < 50) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    retries++;
                }

                if (!window.firebaseDb) {
                    throw new Error('Firestore nen√≠ k dispozici');
                }

                // Inicializace GoPay API
                if (typeof GoPayAPI === 'undefined') {
                    throw new Error('GoPayAPI nen√≠ k dispozici');
                }

                const gopayAPI = new GoPayAPI(GOPAY_CONFIG);

                // Dotaz na stav platby
                const paymentData = await gopayAPI.getPaymentStatus(paymentId);
                console.log('‚úÖ Stav platby:', paymentData.state);

                // Aktualizace stavu v Firestore
                const { updateDoc, doc, getDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                const paymentRef = doc(window.firebaseDb, 'payments', paymentId);
                const paymentSnap = await getDoc(paymentRef);

                if (!paymentSnap.exists()) {
                    console.warn('‚ö†Ô∏è Platba nenalezena v Firestore:', paymentId);
                    document.body.innerHTML = '<h1>Platba nenalezena v datab√°zi</h1>';
                    return;
                }

                const paymentInfo = paymentSnap.data();

                // Aktualizace stavu platby
                await updateDoc(paymentRef, {
                    status: paymentData.state,
                    state: paymentData.state,
                    updatedAt: new Date(),
                    lastNotificationAt: new Date()
                });

                // Pokud je platba zaplacen√°, aktivovat bal√≠ƒçek
                if (paymentData.state === 'PAID' && !paymentInfo.processed) {
                    const userId = paymentInfo.userId;
                    const plan = paymentInfo.plan;

                    if (userId && plan) {
                        const now = new Date();
                        const durationDays = 30;
                        const periodEnd = new Date(now.getTime() + durationDays * 24 * 60 * 60 * 1000);

                        await updateDoc(
                            doc(window.firebaseDb, 'users', userId, 'profile', 'profile'),
                            {
                                plan: plan,
                                planUpdatedAt: now,
                                planPeriodStart: now,
                                planPeriodEnd: periodEnd,
                                planDurationDays: durationDays,
                                planCancelAt: null
                            }
                        );

                        // Oznaƒçit platbu jako zpracovanou
                        await updateDoc(paymentRef, {
                            processed: true,
                            planActivatedAt: now
                        });

                        console.log('‚úÖ Bal√≠ƒçek aktivov√°n pro u≈æivatele:', userId, plan);
                    }
                }

                // Vr√°tit HTTP 200 (GoPay oƒçek√°v√° tento status)
                document.body.innerHTML = '<h1>Notifikace zpracov√°na</h1><p>Stav platby: ' + paymentData.state + '</p>';
                
                // Vr√°tit HTTP 200 status (pro server-side by to mƒõlo b√Ωt automatick√©)
                // V client-side HTML m≈Ø≈æeme jen zobrazit potvrzen√≠
                
            } catch (error) {
                console.error('‚ùå Chyba p≈ôi zpracov√°n√≠ notifikace:', error);
                document.body.innerHTML = '<h1>Chyba p≈ôi zpracov√°n√≠ notifikace</h1><p>' + error.message + '</p>';
            }
        }

        // Spustit zpracov√°n√≠ po naƒçten√≠ str√°nky
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', processNotification);
        } else {
            processNotification();
        }
    </script>
</body>
</html>

